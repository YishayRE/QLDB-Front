---
import NoLoginLayout from '../layouts/NoLoginLayout.astro'
---

<NoLoginLayout title="Historia">
  <section>
    <h1 id="titulo">Historico con error</h1><br>
    <p id="descripcion" class="size-20">Error</p>
  </section>
  <section class="margin-32">
    <div id="chartdiv" style="width: 100%;">
    </div>
  </section>
</NoLoginLayout>

<script is:inline src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script is:inline src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script is:inline src="https://cdn.amcharts.com/lib/4/plugins/forceDirected.js"></script>
<script>
  const titulo = document.getElementById('titulo');
  const descripcion = document.getElementById('descripcion');
  const params = window.location.search;
  const param = params.split('&');
  const id = param[0].split('=')[1];
  const tipo = param[1].split('=')[1];
  console.log(id, tipo);

  const myHeaders = new Headers();
  myHeaders.append("id", id);
  myHeaders.append("Access-Control-Allow-Origin", "*");
  myHeaders.append("Access-Control-Allow-Credentials", "true");
  myHeaders.append("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
  myHeaders.append("Vary", "Origin");
  myHeaders.append("Host", `${import.meta.env.PUBLIC_URL}`);

  const requestOptions = {
    method: 'GET',
    headers: myHeaders,
    redirect: 'follow'
  };
  let resp = {};
  let indicador = '';

  switch (tipo) {
    case 'produccion':
      titulo.innerHTML = 'Historico de la Producción';
      descripcion.innerHTML = `Muestra de los cambios en la producción con bloque ${id}.`;
      resp = await fetch(`${import.meta.env.PUBLIC_API_URL}/producciones/historico/`, requestOptions);
      indicador = 'idProduccion';
      break;
    case 'material':
      titulo.innerHTML = 'Historia del Material';
      descripcion.innerHTML = `Muestra el proceso del material con bloque ${id}.`;
      resp = await fetch(`${import.meta.env.PUBLIC_API_URL}/materiales/historia/`, requestOptions);
      indicador = 'Lote';
      break;
    case 'transporte':
      titulo.innerHTML = 'Historico del Transporte';
      descripcion.innerHTML = `Muestra de los cambios en el transporte con bloque ${id}.`;
      resp = await fetch(`${import.meta.env.PUBLIC_API_URL}/transportes/historico/`, requestOptions);
      indicador = 'idTransporte';
      break;
    default:
      break;
  }

  const {material, transporte, produccion, distribucion, distribuidor, tequila} = await resp.json();

  const namesM = [];
  const namesT = [];
  const namesP = [];
  const namesD = [];
  const namesDr = [];
  const namesTq = [];

  for (const name in material.data)
    if (Object.hasOwnProperty.call(material.data, name))
      namesM.push(name);

  for (const name in transporte.data)
    if (Object.hasOwnProperty.call(transporte.data, name))
      namesT.push(name);

  for (const name in produccion.data)
    if (Object.hasOwnProperty.call(produccion.data, name))
      namesP.push(name);

  for (const name in distribucion.data)
    if (Object.hasOwnProperty.call(distribucion.data, name))
      namesD.push(name);
    
  for (const name in distribuidor.data)
    if (Object.hasOwnProperty.call(distribuidor.data, name))
      namesDr.push(name);
  
  for (const name in tequila.data)
    if (Object.hasOwnProperty.call(tequila.data, name))
      namesTq.push(name);

  const chart = am4core.create("chartdiv", am4plugins_forceDirected.ForceDirectedTree);
  // Create series

  let series = chart.series.push(new am4plugins_forceDirected.ForceDirectedSeries())

  const mat = namesM.map(name => {
    if(name == '_idProduccion')
      return {
        "id": "Material2",
        "name": name,
        "collapsed": true,
        "value": 0.75,
        "valorPropio": material.data[name],
        "link": ["Produccion", "Distribucion"],
      }
    return {
      "name": name,
      "collapsed": true,
      "value": 0.75,
      "valorPropio": material.data[name],
    }
  });

  const tran = namesT.map(name => {
    if(name == '_idMaterial')
      return;
    else
      return {
        "name": name,
        "collapsed": true,
        "value": 0.75,
        "valorPropio": transporte.data[name],
      }
  }).filter(item => item);

  const prod = namesP.map(name => {
    return {
      "name": name,
      "collapsed": true,
      "value": 0.75,
      "valorPropio": produccion.data[name],
    }
  });

  const dist = namesD.map(name => {
    if(name == 'idProduccion')
      return;
    return {
      "name": name,
      "collapsed": true,
      "value": 0.75,
      "valorPropio": distribucion.data[name],
    }
  }).filter(item => item);

  const distr = namesDr.map(name => {
    if(name == 'idDistribucion')
      return;
    return {
      "name": name,
      "collapsed": true,
      "value": 0.75,
      "valorPropio": distribuidor.data[name],
    }
  }).filter(item => item);

  const teq = namesTq.map(name => {
    if(name == 'idDistribuidor')
      return;
    return {
      "name": name,
      "collapsed": true,
      "value": 0.75,
      "valorPropio": tequila.data[name],
    }
  }).filter(item => item);

  const bloqueM = {
    "id": "Material1",
    "name": 'bloque',
    "valorPropio": material.metadata.id,
    "collapsed": true,
    "value": 0.75,
    "link": "Transporte",
  }

  const bloqueT = {
    "name": 'bloque',
    "valorPropio": transporte.metadata.id,
    "collapsed": true,
    "value": 0.75,
  }

  const bloqueD = {
    "id": "DistribucionID",
    "name": 'bloque',
    "valorPropio": distribucion.metadata.id,
    "collapsed": true,
    "value": 0.75,
    "link": "Distribuidor"
  }

  const bloqueDr = {
    "id": "DistribuidorID",
    "name": 'bloque',
    "valorPropio": distribuidor.metadata.id,
    "collapsed": true,
    "value": 0.75,
    "link": "Tequila"
  }

  const bloqueTq = {
    "name": 'bloque',
    "valorPropio": tequila.metadata.id,
    "collapsed": true,
    "value": 0.75,
  }

  const transporteC = {
    "id": "Transporte",
    "name": 'Nombre',
    "valorPropio": 'Transporte',
    "collapsed": true,
    "value": 1,
    "link": ["Material1"],
    "children": [...tran, bloqueT]
  }

  const produccionC = {
    "id": "Produccion",
    "name": 'Nombre',
    "valorPropio": 'Produccion',
    "collapsed": true,
    "value": 1,
    "link": ["Material2"],
    "children": prod
  }

  const distribucionC = {
    "id": "Distribucion",
    "name": 'Nombre',
    "valorPropio": 'Distribucion',
    "collapsed": true,
    "value": 1,
    "link": ["Material2"],
    "children": [...dist, bloqueD]
  }

  const distribuidorC = {
    "id": "Distribuidor",
    "name": 'Nombre',
    "valorPropio": 'Distribuidor',
    "collapsed": true,
    "value": 1,
    "link": ["DistribucionID"],
    "children": [...distr, bloqueDr]
  }

  const tequilaC = {
    "id": "Tequila",
    "name": 'Nombre',
    "valorPropio": 'Tequila',
    "collapsed": true,
    "value": 1,
    "link": ["DistribuidorID"],
    "children": [...teq, bloqueTq]
  }

  // Set data
  series.data = [{
    "id": "Material",
    "name": 'Nombre',
    "collapsed": false,
    "valorPropio": 'Material',
    "value": 1,
    "children": [...mat, bloqueM]
  }, transporteC, produccionC, distribucionC, distribuidorC, tequilaC];

  // Set up data fields
  series.dataFields.value = "value";
  series.dataFields.name = "name";
  series.dataFields.children = "children";
  series.dataFields.collapsed = "collapsed";
  series.dataFields.id = "id";
  series.dataFields.linkWith = "link";

  // Add labels
  series.nodes.template.label.text = "{valorPropio}";
  series.nodes.template.tooltipText = "{name}: {valorPropio}";
  series.nodes.template.label.truncate = true;
  series.fontSize = 16;
  series.maxRadius = 60;
  series.minRadius = 20;
  series.links.template.strokeWidth = 5;

  hideLoader();
</script>

<style>
  #chartdiv{
    height: 75vh;
    overflow: auto;
  }
</style>